<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Authenticator – Garena & TOTP</title>
  <style>
    :root{
      --bg:#f4f6f8;--panel:#fff;--text:#2d2d2d;--muted:#666;
      --accent:#4cd964;--accent2:#34c759;--bd:#e6e6e6
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,sans-serif;min-height:100dvh;padding:20px}
    h1{margin:0 0 12px;font-size:18px}
    .container{display:flex;gap:20px;flex-wrap:wrap;justify-content:center}
    .panel{flex:1 1 320px;max-width:480px;background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:18px;box-shadow:0 4px 12px rgba(0,0,0,.06);opacity:0;transform:translateY(8px);animation:fade .35s ease forwards}
    @keyframes fade{to{opacity:1;transform:none}}
    textarea,input[type=text]{width:100%;background:#fafafa;border:1px solid #ccc;border-radius:12px;color:var(--text);padding:12px 14px;font-size:14px;outline:none}
    textarea:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(76,217,100,.18)}
    .controls{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    button{appearance:none;border:1px solid #ccc;background:#f9f9f9;color:var(--text);border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;flex:1;transition:.2s}
    button.primary{background:var(--accent);border-color:var(--accent2);color:#fff}
    button:hover{opacity:.9}
    .card{margin-top:14px;border:1px solid #eee;border-radius:14px;padding:14px;background:#fafafa;text-align:center}
    .code{font-variant-numeric:tabular-nums;font-size:clamp(34px,8vw,56px);font-weight:900;letter-spacing:.08em;text-shadow:0 0 10px rgba(76,217,100,.15)}
    .meta{margin-top:6px;color:var(--muted);font-size:13px}
    .progress{height:8px;background:#e5e5e5;border-radius:999px;overflow:hidden;margin-top:10px}
    .bar{height:100%;width:0%}
    .bar1{background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .bar2{background:linear-gradient(90deg,var(--accent2),var(--accent))}
    .warn{margin-top:8px;font-size:12px;color:#b57a00;text-align:center;min-height:1.2em}
    .accent1{color:var(--accent)} .accent2{color:var(--accent2)}
  </style>
</head>
<body>
  <div class="container">
    <!-- Garena Authenticator (180s) -->
    <div class="panel" id="garenaPanel">
      <h1>Garena Authenticator (180s)</h1>
      <input id="garenaSecret" type="text" spellcheck="false" placeholder="Nhập secret Base32 (VD: JBSWY3DPEHPK3PXP)">
      <div class="controls">
        <button data-act="save" class="primary">Lưu</button>
        <button data-act="clear">Xoá</button>
        <button data-act="paste">Dán</button>
        <button data-act="copy">Copy mã</button>
      </div>
      <div class="warn" id="garenaWarn"></div>
      <div class="card">
        <div class="code accent1" id="garenaOtp">------</div>
        <div class="meta">Còn <span id="garenaRemain">--</span> giây</div>
        <div class="progress"><div class="bar bar1" id="garenaBar"></div></div>
      </div>
    </div>

    <!-- TOTP Chuẩn (30s) -->
    <div class="panel" id="totpPanel">
      <h1>TOTP Chuẩn (30s)</h1>
      <textarea id="totpSecret" spellcheck="false" placeholder="Dán otpauth://totp/... hoặc secret Base32"></textarea>
      <div class="controls"><button id="totpStart" class="primary">Bắt đầu</button></div>
      <div class="warn" id="totpWarn"></div>
      <div class="card" id="totpOut" style="display:none">
        <div class="code accent2" id="totpOtp">000 000</div>
        <div class="meta"><span id="totpRemain">30</span>s nữa đổi mã</div>
        <div class="progress"><div class="bar bar2" id="totpBar"></div></div>
      </div>
    </div>
  </div>

  <script>
    /* ========== Helpers dùng chung ========== */
    const $ = (id) => document.getElementById(id);

    // Base32 -> Uint8Array (bỏ space/-,_,=,.)
    function base32ToBytes(b32) {
      const s = b32.toUpperCase().replace(/[\s\-=_.]/g, '');
      const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      let bits = 0, val = 0, out = [];
      for (let i = 0; i < s.length; i++) {
        const idx = alpha.indexOf(s[i]);
        if (idx < 0) throw new Error('Secret Base32 không hợp lệ.');
        val = (val << 5) | idx; bits += 5;
        if (bits >= 8) { out.push((val >>> (bits - 8)) & 0xff); bits -= 8; }
      }
      return new Uint8Array(out);
    }

    // Tạo buffer counter 8 bytes (big-endian)
    function counterBuf(counter) {
      const buf = new ArrayBuffer(8), v = new DataView(buf);
      v.setUint32(0, Math.floor(counter / 0x100000000));
      v.setUint32(4, counter >>> 0);
      return buf;
    }

    // Import key HMAC-SHA1
    async function importHmacKey(secretBytes) {
      return crypto.subtle.importKey('raw', secretBytes, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
    }

    // HMAC-SHA1(counter) -> Uint8Array
    async function hmacSha1(cryptoKey, counter) {
      const sig = await crypto.subtle.sign('HMAC', cryptoKey, counterBuf(counter));
      return new Uint8Array(sig);
    }

    // Trích xuất 6 số: mode="standard" (RFC: offset = lastByte & 0x0f) hoặc "garena" (offset = lastByte % 16)
    function hotpFromSig(sig, digits = 6, mode = 'standard') {
      const last = sig[sig.length - 1];
      const offset = mode === 'garena' ? (last % 16) : (last & 0x0f);
      const bin = ((sig[offset] & 0x7f) << 24) | (sig[offset + 1] << 16) | (sig[offset + 2] << 8) | (sig[offset + 3]);
      return String(bin % (10 ** digits)).padStart(digits, '0');
    }

    // Format 6 số thành "xxx xxx"
    const fmt6 = (code) => code.replace(/(\d{3})(?=\d)/g, '$1 ');

    // Thanh tiến độ percent theo chu kỳ
    function progressPct(period, nowSec) {
      const remain = period - (nowSec % period);
      const pct = ((period - remain) / period) * 100;
      return { remain, pct };
    }

    /* ========== Garena 180s ========== */
    (function garenaInit(){
      const PERIOD = 180;
      const els = {
        secret: $('garenaSecret'),
        otp:    $('garenaOtp'),
        remain: $('garenaRemain'),
        bar:    $('garenaBar'),
        warn:   $('garenaWarn'),
        panel:  $('garenaPanel'),
      };

      // Khôi phục secret đã lưu
      const LS_KEY = 'garena_secret';
      const saved = localStorage.getItem(LS_KEY);
      if (saved) els.secret.value = saved;

      // Cảnh báo ngắn
      const toast = (msg) => { els.warn.textContent = msg; setTimeout(()=> els.warn.textContent='', 1800); };

      // Nút hành động
      els.panel.querySelector('[data-act="save"]').onclick  = () => { localStorage.setItem(LS_KEY, els.secret.value.trim()); toast('Đã lưu secret.'); };
      els.panel.querySelector('[data-act="clear"]').onclick = () => { localStorage.removeItem(LS_KEY); els.secret.value=''; els.otp.textContent='------'; toast('Đã xoá.'); };
      els.panel.querySelector('[data-act="paste"]').onclick = async () => { try{ els.secret.value=(await navigator.clipboard.readText()).trim(); toast('Đã dán.'); }catch{} };
      els.panel.querySelector('[data-act="copy"]').onclick  = async () => { try{ await navigator.clipboard.writeText(els.otp.textContent.replace(/\s/g,'')); toast('Đã copy.'); }catch{} };

      async function tick(){
        const raw = els.secret.value.trim();
        if (!raw) { els.otp.textContent='------'; const {remain,pct}=progressPct(PERIOD,Math.floor(Date.now()/1000)); els.remain.textContent='--'; els.bar.style.width='0%'; return; }
        try{
          const key = await importHmacKey(base32ToBytes(raw));
          const step = Math.floor(Date.now()/1000/PERIOD);
          const sig = await hmacSha1(key, step);
          const code = hotpFromSig(sig, 6, 'garena');
          els.otp.textContent = fmt6(code);
        }catch{ els.otp.textContent='ERR'; }

        const now = Math.floor(Date.now()/1000);
        const {remain, pct} = progressPct(PERIOD, now);
        els.remain.textContent = remain;
        els.bar.style.width = pct + '%';
      }
      setInterval(tick, 300); tick();
    })();

    /* ========== TOTP chuẩn 30s ========== */
    (function totpInit(){
      const PERIOD = 30, DIGITS = 6;
      const elSecret = $('totpSecret');
      const elStart  = $('totpStart');
      const elWarn   = $('totpWarn');
      const elOut    = $('totpOut');
      const elOtp    = $('totpOtp');
      const elRemain = $('totpRemain');
      const elBar    = $('totpBar');

      let key = null, lastCounter = -1, timer = null;

      const warn = (m) => { elWarn.textContent=m; setTimeout(()=> elWarn.textContent='', 1800); };

      function normalizeSecret(raw){
        if (!raw) throw new Error('Chưa nhập secret');
        raw = raw.trim();
        if (raw.toLowerCase().startsWith('otpauth://')) {
          try {
            const u = new URL(raw);
            const s = u.searchParams.get('secret') || '';
            if (!s) throw 0;
            return s;
          } catch { throw new Error('otpauth URI không hợp lệ.'); }
        }
        return raw;
      }

      async function prepareKey() {
        const bytes = base32ToBytes(normalizeSecret(elSecret.value));
        key = await importHmacKey(bytes);
      }

      async function tick(){
        if (!key) return;
        const t = Math.floor(Date.now()/1000);
        const counter = Math.floor(t / PERIOD);
        const remain  = PERIOD - (t % PERIOD);
        elRemain.textContent = remain;
        elBar.style.width = ((PERIOD - remain) / PERIOD) * 100 + '%';

        if (counter !== lastCounter) {
          lastCounter = counter;
          try {
            const sig = await hmacSha1(key, counter);
            const code = hotpFromSig(sig, DIGITS, 'standard');
            elOtp.textContent = fmt6(code);
          } catch(e){ warn(e.message); }
        }
      }

      elStart.onclick = async () => {
        try {
          await prepareKey();
          elOut.style.display = '';
          if (timer) clearInterval(timer);
          timer = setInterval(tick, 300);
          tick();
        } catch(e){ warn(e.message); }
      };
    })();
  </script>
</body>
</html>
