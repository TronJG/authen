<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Authenticator – Garena & TOTP</title>
    <style>
        :root {
            --bg: #f4f6f8;
            --panel: #ffffff;
            --text: #2d2d2d;
            --muted: #666;
            --accent: #4cd964;
            --accent2: #34c759;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, Segoe UI, Roboto, sans-serif;
            min-height: 100dvh;
            padding: 20px
        }

        h1 {
            margin: 0 0 12px;
            font-size: 18px
        }

        .container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center
        }

        .panel {
            flex: 1 1 320px;
            max-width: 480px;
            background: var(--panel);
            border: 1px solid #ddd;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .06)
        }

        textarea,
        input[type=text] {
            width: 100%;
            background: #fafafa;
            border: 1px solid #ccc;
            border-radius: 12px;
            color: var(--text);
            padding: 12px 14px;
            font-size: 14px;
            outline: none
        }

        textarea:focus,
        input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(76, 217, 100, .2)
        }

        .panel {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        button {
            appearance: none;
            border: 1px solid #ccc;
            background: #f9f9f9;
            color: var(--text);
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            transition: all .2s
        }

        button.primary {
            background: var(--accent);
            border-color: var(--accent2);
            color: white
        }

        button:hover {
            opacity: .9
        }

        .card {
            margin-top: 14px;
            border: 1px solid #eee;
            border-radius: 14px;
            padding: 14px;
            background: #fafafa;
            text-align: center
        }

        .code {
            font-variant-numeric: tabular-nums;
            font-size: clamp(34px, 8vw, 56px);
            font-weight: 900;
            letter-spacing: .08em;
            text-shadow: 0 0 10px rgba(76, 217, 100, .15)
        }

        .meta {
            margin-top: 6px;
            color: var(--muted);
            font-size: 13px
        }

        .progress {
            height: 8px;
            background: #e5e5e5;
            border-radius: 999px;
            overflow: hidden;
            margin-top: 10px
        }

        .bar {
            height: 100%;
            width: 0%;
        }

        .warn {
            margin-top: 8px;
            font-size: 12px;
            color: #b57a00;
            text-align: center
        }

        .accent1 {
            color: var(--accent)
        }

        .accent2 {
            color: var(--accent2)
        }

        .bar1 {
            background: linear-gradient(90deg, var(--accent), var(--accent2))
        }

        .bar2 {
            background: linear-gradient(90deg, var(--accent2), var(--accent))
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Garena Authenticator -->
        <div class="panel" id="garenaPanel">
            <h1>Garena Authenticator (180s)</h1>
            <input id="garenaSecret" type="text" spellcheck="false"
                placeholder="Nhập secret Base32 (VD: JBSWY3DPEHPK3PXP)">
            <div class="controls">
                <button id="garenaSave" class="primary">Lưu</button>
                <button id="garenaClear">Xoá</button>
                <button id="garenaPaste">Dán</button>
                <button id="garenaCopy">Copy mã</button>
            </div>
            <div id="garenaWarn" class="warn"></div>
            <div class="card">
                <div class="code accent1" id="garenaOtp">------</div>
                <div class="meta">Còn <span id="garenaRemain">--</span> giây</div>
                <div class="progress">
                    <div class="bar bar1" id="garenaBar"></div>
                </div>
            </div>
        </div>

        <!-- TOTP Authenticator -->
        <div class="panel" id="totpPanel">
            <h1>TOTP Chuẩn (30s)</h1>
            <textarea id="totpSecret" spellcheck="false"
                placeholder="Dán otpauth://totp/... hoặc secret Base32"></textarea>
            <div class="controls">
                <button id="totpStart" class="primary">Bắt đầu</button>
            </div>
            <div id="totpWarn" class="warn"></div>
            <div class="card" id="totpOut" style="display:none">
                <div class="code accent2" id="totpOtp">000 000</div>
                <div class="meta"><span id="totpRemain">30</span>s nữa đổi mã</div>
                <div class="progress">
                    <div class="bar bar2" id="totpBar"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ===== Garena Authenticator (180s) ===== */
        function base32Decode(b32) {
            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
            const clean = b32.toUpperCase().replace(/=+$/, "").replace(/\s+/g, "");
            let bits = "", out = [];
            for (const ch of clean) {
                const val = alphabet.indexOf(ch);
                if (val === -1) throw new Error("Secret không đúng Base32");
                bits += val.toString(2).padStart(5, "0");
            }
            for (let i = 0; i + 8 <= bits.length; i += 8) {
                out.push(parseInt(bits.slice(i, i + 8), 2));
            }
            return new Uint8Array(out);
        }
        async function garenaOTP(secretB32) {
            const keyBytes = base32Decode(secretB32);
            const STEP_SECONDS = 180;
            const step = Math.floor(Date.now() / 1000 / STEP_SECONDS);
            const msg = new ArrayBuffer(8);
            const view = new DataView(msg);
            view.setUint32(0, Math.floor(step / 0x100000000));
            view.setUint32(4, step >>> 0);
            const cryptoKey = await crypto.subtle.importKey("raw", keyBytes, { name: "HMAC", hash: "SHA-1" }, false, ["sign"]);
            const sig = new Uint8Array(await crypto.subtle.sign("HMAC", cryptoKey, msg));
            const last = sig[19];
            const index = last % 16;
            const part = (sig[index] << 24) | (sig[index + 1] << 16) | (sig[index + 2] << 8) | (sig[index + 3]);
            const num = (part & 0x7fffffff) % 1000000;
            return num.toString().padStart(6, "0");
        }
        (function initGarena() {
            const STEP_SECONDS = 180;
            const $ = id => document.getElementById(id);
            const secInput = $("garenaSecret"), otpEl = $("garenaOtp"), remEl = $("garenaRemain"), barEl = $("garenaBar"), warnEl = $("garenaWarn");
            if (localStorage.getItem("garena_secret")) secInput.value = localStorage.getItem("garena_secret");
            function warn(msg) { warnEl.textContent = msg; setTimeout(() => warnEl.textContent = "", 2000); }
            $("garenaSave").onclick = () => { localStorage.setItem("garena_secret", secInput.value.trim()); warn("Đã lưu secret."); };
            $("garenaClear").onclick = () => { localStorage.removeItem("garena_secret"); secInput.value = ""; otpEl.textContent = "------"; warn("Đã xoá."); };
            $("garenaPaste").onclick = async () => { try { secInput.value = (await navigator.clipboard.readText()).trim(); warn("Đã dán."); } catch { } };
            $("garenaCopy").onclick = async () => { try { await navigator.clipboard.writeText(otpEl.textContent.replace(/\s/g, "")); warn("Đã copy."); } catch { } };
            async function tick() {
                try {
                    const sec = secInput.value.trim();
                    if (!sec) { otpEl.textContent = "------"; remEl.textContent = "--"; barEl.style.width = "0%"; return; }
                    const otp = await garenaOTP(sec);
                    otpEl.textContent = otp.replace(/(...)/g, "$1 ").trim();
                } catch { otpEl.textContent = "ERR"; }
                const now = Math.floor(Date.now() / 1000); const left = STEP_SECONDS - (now % STEP_SECONDS);
                remEl.textContent = left; barEl.style.width = ((STEP_SECONDS - left) / STEP_SECONDS) * 100 + "%";
            }
            setInterval(tick, 300); tick();
        })();

        /* ===== TOTP Authenticator (30s) ===== */
        (function initTOTP() {
            const $ = id => document.getElementById(id);
            const elSecret = $("totpSecret"), elStart = $("totpStart"), elWarn = $("totpWarn");
            const elOut = $("totpOut"), elOtp = $("totpOtp"), elRemain = $("totpRemain"), elBar = $("totpBar");
            const DIGITS = 6, PERIOD = 30; let key = null, lastCounter = -1, timer = null;
            function warn(msg) { elWarn.textContent = msg; setTimeout(() => elWarn.textContent = "", 2000); }
            function base32ToBytes(b32) { const s = b32.toUpperCase().replace(/[\s\-=_.]/g, ''), alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567'; let bits = 0, val = 0, out = []; for (let i = 0; i < s.length; i++) { const idx = alpha.indexOf(s[i]); if (idx < 0) throw new Error('Secret Base32 không hợp lệ.'); val = (val << 5) | idx; bits += 5; if (bits >= 8) { out.push((val >>> (bits - 8)) & 0xff); bits -= 8; } } return new Uint8Array(out); }
            function ctrBuf(counter) { const buf = new ArrayBuffer(8), v = new DataView(buf); v.setUint32(0, Math.floor(counter / 0x100000000)); v.setUint32(4, counter >>> 0); return buf; }
            async function importKey(secretBytes) { return await crypto.subtle.importKey('raw', secretBytes, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']); }
            async function hotp(key, counter, digits) { const sig = new Uint8Array(await crypto.subtle.sign('HMAC', key, ctrBuf(counter))); const offset = sig[sig.length - 1] & 0x0f; const bin = ((sig[offset] & 0x7f) << 24) | (sig[offset + 1] << 16) | (sig[offset + 2] << 8) | (sig[offset + 3]); return String(bin % (10 ** digits)).padStart(digits, '0'); }
            async function prepareKey() { let raw = elSecret.value.trim(); if (!raw) throw new Error('Chưa nhập secret'); if (raw.toLowerCase().startsWith('otpauth://')) { try { const u = new URL(raw); raw = u.searchParams.get('secret') || ''; } catch { throw new Error('otpauth URI không hợp lệ.'); } } const bytes = base32ToBytes(raw); key = await importKey(bytes); }
            async function tick() { if (!key) return; const t = Math.floor(Date.now() / 1000); const counter = Math.floor(t / PERIOD); const remain = PERIOD - (t % PERIOD); elRemain.textContent = remain; elBar.style.width = ((PERIOD - remain) / PERIOD) * 100 + '%'; if (counter !== lastCounter) { lastCounter = counter; try { const code = await hotp(key, counter, DIGITS); elOtp.textContent = code.replace(/(\d{3})(?=\d)/g, '$1 '); } catch (e) { warn(e.message); } } }
            elStart.onclick = async () => { try { await prepareKey(); elOut.style.display = ''; if (timer) clearInterval(timer); timer = setInterval(tick, 300); tick(); } catch (e) { warn(e.message); } };
        })();
    </script>
</body>

</html>
